<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    
    <title>03. 集群相关 (节点, 分片及角色, 扩容, 故障测试) | Lant&#39;s</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="Elasticsearch">
    <meta name="description" content="前言 ElasticSearch 的主旨是随时可用和按需扩容, 这里主要是说 水平(横向)扩容 — 为集群添加更多的节点将负载压力分散到这些节点中; ElastiSearch 天生就是分布式的, 它知道如何通过管理多节点来提高扩容性和可用性; 接下来将讲述如何按需配置集群、节点和分片, 并在硬件故障时确保数据安全  节点 及其 角色 节点: 一个运行中的 Elasticsearch 实例就称为一个">
<meta name="keywords" content="Elasticsearch">
<meta property="og:type" content="article">
<meta property="og:title" content="03. 集群相关 (节点, 分片及角色, 扩容, 故障测试)">
<meta property="og:url" content="http://blog.renyimin.com/2018/06/10/elasticsearch/2018-06-10-03/index.html">
<meta property="og:site_name" content="Lant&#39;s">
<meta property="og:description" content="前言 ElasticSearch 的主旨是随时可用和按需扩容, 这里主要是说 水平(横向)扩容 — 为集群添加更多的节点将负载压力分散到这些节点中; ElastiSearch 天生就是分布式的, 它知道如何通过管理多节点来提高扩容性和可用性; 接下来将讲述如何按需配置集群、节点和分片, 并在硬件故障时确保数据安全  节点 及其 角色 节点: 一个运行中的 Elasticsearch 实例就称为一个">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://blog.renyimin.com/img/est/blogs-unassigned-yellow.png">
<meta property="og:image" content="http://blog.renyimin.com/img/est/blogs-green.png">
<meta property="og:image" content="http://blog.renyimin.com/img/est/blogs-green-03.png">
<meta property="og:image" content="http://blog.renyimin.com/img/est/blogs-green-03.png">
<meta property="og:image" content="http://blog.renyimin.com/img/est/9200-down.png">
<meta property="og:image" content="http://blog.renyimin.com/img/est/9201-green.png">
<meta property="og:image" content="http://blog.renyimin.com/img/est/9202-green.png">
<meta property="og:image" content="http://blog.renyimin.com/img/est/node-ok.png">
<meta property="og:updated_time" content="2018-09-19T12:31:02.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="03. 集群相关 (节点, 分片及角色, 扩容, 故障测试)">
<meta name="twitter:description" content="前言 ElasticSearch 的主旨是随时可用和按需扩容, 这里主要是说 水平(横向)扩容 — 为集群添加更多的节点将负载压力分散到这些节点中; ElastiSearch 天生就是分布式的, 它知道如何通过管理多节点来提高扩容性和可用性; 接下来将讲述如何按需配置集群、节点和分片, 并在硬件故障时确保数据安全  节点 及其 角色 节点: 一个运行中的 Elasticsearch 实例就称为一个">
<meta name="twitter:image" content="http://blog.renyimin.com/img/est/blogs-unassigned-yellow.png">
    
        <link rel="alternate" type="application/atom+xml" title="Lant&#39;s" href="/atom.xml">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="/css/style.css?v=1.6.13">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand3.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpeg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">Lant</h5>
          <a href="mailto:18625036504@163.com" title="18625036504@163.com" class="mail">18625036504@163.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                归档
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                标签
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                分类
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">03. 集群相关 (节点, 分片及角色, 扩容, 故障测试)</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h5 class="subtitle">
            
                <time datetime="2018-06-10T06:26:39.000Z" itemprop="datePublished" class="page-time">
  2018-06-10
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Elasticsearch/">Elasticsearch</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#前言"><span class="post-toc-number">1.</span> <span class="post-toc-text">前言</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#节点-及其-角色"><span class="post-toc-number">2.</span> <span class="post-toc-text">节点 及其 角色</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#集群"><span class="post-toc-number">3.</span> <span class="post-toc-text">集群</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#分片"><span class="post-toc-number">4.</span> <span class="post-toc-text">分片</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#故障转移"><span class="post-toc-number">5.</span> <span class="post-toc-text">故障转移</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#水平扩容"><span class="post-toc-number">6.</span> <span class="post-toc-text">水平扩容</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#更多的扩容提升搜索性能"><span class="post-toc-number">7.</span> <span class="post-toc-text">更多的扩容提升搜索性能</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#故障测试"><span class="post-toc-number">8.</span> <span class="post-toc-text">故障测试</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#配置相关"><span class="post-toc-number">9.</span> <span class="post-toc-text">配置相关</span></a></li></ol>
        </nav>
    </aside>
    
<article id="post-elasticsearch/2018-06-10-03"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">03. 集群相关 (节点, 分片及角色, 扩容, 故障测试)</h1>
        <div class="post-meta">
            <time class="post-time" title="2018-06-10 14:26:39" datetime="2018-06-10T06:26:39.000Z"  itemprop="datePublished">2018-06-10</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Elasticsearch/">Elasticsearch</a></li></ul>



            

        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><ol>
<li>ElasticSearch 的主旨是随时可用和按需扩容, 这里主要是说 水平(横向)扩容 — 为集群添加更多的节点将负载压力分散到这些节点中; ElastiSearch 天生就是分布式的, 它知道如何通过管理多节点来提高扩容性和可用性;</li>
<li>接下来将讲述如何按需配置集群、节点和分片, 并在硬件故障时确保数据安全</li>
</ol>
<h2 id="节点-及其-角色"><a href="#节点-及其-角色" class="headerlink" title="节点 及其 角色"></a>节点 及其 角色</h2><ol>
<li><p>节点: 一个运行中的 Elasticsearch 实例就称为一个节点; </p>
</li>
<li><p>默认情况下, es 集群中每个节点都有成为主节点的资格, 也都存储数据, 还可以提供查询服务, 这些功能是由两个属性控制的</p>
<ul>
<li><code>node.master</code>: 这个属性表示节点是否具有成为主节点的资格 (注意: 此属性的值为true, 并不意味着这个节点就是主节点; 真正的主节点, 是由多个具有主节点资格的节点进行选举产生的; 所以, 这个属性只是代表这个节点是不是具有主节点选举资格)</li>
<li><code>node.data</code>: 这个属性表示节点是否存储数据;</li>
</ul>
</li>
<li><p>上面两个配置属性可以有四种组合:</p>
<ul>
<li><p>节点只有成为主节点的资格(有可能成为真正的主节点), 但不会存储数据; 称为master节点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">node.master: true</span><br><span class="line">node.data: false</span><br></pre></td></tr></table></figure>
</li>
<li><p>节点没有成为主节点的资格, 即, 不参与选举, 只会存储数据; 称为data(数据)节点<br>在集群中需要单独设置几个这样的节点负责存储数据, 后期提供存储和查询服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">node.master: false</span><br><span class="line">node.data: true</span><br></pre></td></tr></table></figure>
</li>
<li><p>节点既不会成为主节点, 也不会存储数据 (也叫协调节点/路由节点)<br>这个节点的意义是作为一个client(客户端)节点, 主要是针对海量请求的时候可以进行负载均衡</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">node.master: false</span><br><span class="line">node.data: false</span><br></pre></td></tr></table></figure>
</li>
<li><p>既有成为主节点的资格, 又存储数据:<br>如果这个节点被选举成了真正的主节点, 那么它除了干主节点要干的活, 还要存储数据, 这样对于这个节点的压力就比较大;<br>elasticsearch 默认每个节点都是这样的配置, 在测试环境下这样做没问题, 但是实际工作中建议不要这样设置; 因为这样相当于 主节点 和 数据节点 的角色混合到一块了;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">node.master: false</span><br><span class="line">node.data: true</span><br></pre></td></tr></table></figure>
</li>
<li><p>默认情况下, 每个节点都有成为主节点的资格, 也会存储数据, 还会处理客户端的请求;</p>
</li>
<li><p>根据前面节点及其角色的介绍, 如果尝试配置唯一的节点为 <code>node.master: true node.data: false</code>, 则节点中的所有分片都会是未分配状态</p>
</li>
<li>如果配置为 <code>node.master: false node.data: false</code>, 貌似无法启动</li>
</ul>
</li>
<li><p>在生产集群中我们可以对这些节点的职责进行划分</p>
<ul>
<li>建议集群中设置3台以上的节点作为master节点 <code>node.master: true node.data: false</code>, 这些节点只负责成为主节点, 维护整个集群的状态;</li>
<li>再根据数据量设置一批data节点 <code>node.master: false node.data: true</code>, 这些节点只负责存储数据, 后期提供建立索引和查询索引的服务, 这样的话如果用户请求比较频繁, 这些节点的压力也会比较大;</li>
<li>所以在集群中建议再设置一批client节点 <code>node.master: false node.data: false</code>, 这些节点只负责处理用户请求, 实现请求转发, 负载均衡等功能;<br>master节点: 普通服务器即可(CPU 内存 消耗一般)<br>data节点: 主要消耗磁盘, 内存<br>client节点: 普通服务器即可(如果要进行分组聚合操作的话, 建议这个节点内存也分配多一点)</li>
</ul>
</li>
</ol>
<h2 id="集群"><a href="#集群" class="headerlink" title="集群"></a>集群</h2><ol>
<li><p>集群是由一个或者多个拥有相同 <code>cluster.name</code> 配置项的节点组成, 这些节点共同承担数据和负载的压力; 当有节点加入集群中或者从集群中移除节点时, 集群将会重新平均分布所有的数据;</p>
</li>
<li><p>当一个节点被选举成为 主节点 时, 它将负责管理集群范围内的所有变更, 例如增加、删除索引, 或者增加、删除节点等; </p>
<ul>
<li>不过, <strong>纯粹的主节点</strong>并不需要涉及到文档级别的变更和搜索等操作, 所以, 集群所拥有的唯一一个主节点, 如果是纯粹的主节点的话, 即使流量的增加它也不会成为瓶颈;  </li>
<li>任何节点都可以成为主节点, 到目前为止, 我们之前的示例集群就只有一个节点, 当然, 它同时也是主节点;    </li>
</ul>
</li>
<li><p>作为用户, 我们可以将请求发送到集群中的任何节点, 包括主节点; 每个节点都知道任意文档所处的位置, 并且能够将我们的请求直接转发到存储我们所需文档的节点, 无论我们将请求发送到哪个节点, 它都能负责从各个包含我们所需文档的节点收集回数据, 并将最终结果返回給客户端, Elasticsearch 对这一切的管理都是透明的。</p>
</li>
<li><p>集群健康, 可以通过 <code>GET /_cluster/health</code> 来查看, 对于返回结果, 最需要关心的是 <code>status</code> 字段, 它指示着当前集群在总体上是否工作正常, 它的三种颜色含义如下:</p>
<ul>
<li><strong>green</strong> 所有的主分片和副本分片都正常运行</li>
<li><strong>yellow</strong> 所有的主分片都正常运行, 但不是所有的副本分片都正常运行</li>
<li><strong>red</strong> 有主分片没能正常运行</li>
</ul>
</li>
</ol>
<h2 id="分片"><a href="#分片" class="headerlink" title="分片"></a>分片</h2><ol>
<li><p>我们往 Elasticsearch 添加数据时需要用到 索引(保存相关数据的地方), 而索引实际上是指向一个或者多个物理分片的<strong>逻辑命名空间</strong>;</p>
</li>
<li><p><strong>分片</strong>: 一个分片是一个 Lucene 的实例, 它是一个底层的工作单元, 其本身就是一个完整的搜索引擎; 但是, 它可能仅保存了全部文档中的一部分;</p>
</li>
<li><p>Elasticsearch 是利用分片将数据分发到集群内各处的, 分片是数据的容器, 文档保存在分片内, 分片又被分配到集群内的各个节点里; <strong>当你的集群规模扩大或者缩小时(即增加或减少节点时), Elasticsearch 会自动的在各节点中迁移分片, 使得数据仍然均匀分布在集群里</strong>。</p>
</li>
<li><p>分片有两种类型: 主分片, 副本分片</p>
<ul>
<li>索引内任意一个文档都归属于一个主分片, 所以主分片的数目决定着索引能够保存的最大数据量;</li>
<li>而副本分片只是一个主分片的拷贝, 副本分片作为硬件故障时保护数据不丢失的冗余备份, 并为搜索和返回文档等读操作提供服务;</li>
<li>注意: 在索引建立的时候就确定了主分片数,之后无法随意修改;而副本分片数可以随时修改;</li>
</ul>
</li>
<li><p>每个索引在默认情况下会被分配5个主分片, 不过你也可以在创建索引前, 先指定索引的 主分片数  和 每个主分片对应的副本分片数, 如下, 给 blogs 索引分配3个主分片 和 每个主分片分配1个副本:</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PUT /blogs</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot; : &#123;</span><br><span class="line">     &quot;number_of_shards&quot; : 3,</span><br><span class="line">     &quot;number_of_replicas&quot; : 1</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 不过, 由于当前只有一个节点, 所以集群的健康状况为 yellow , 表示全部主分片都正常运行(集群可以正常服务所有请求), 但是副本分片没有全部处在正常状态;<br> 实际上, 所有3个副本分片都是 unassigned —— 它们都没有被分配到任何节点, 因为当前只有一个节点, 而在同一个节点上既保存原始数据又保存副本是没有意义的;<br> 当前这种状况, 一旦失去了唯一的节点, 也就会丢失该节点上的所有副本数据; 当前我们的集群是正常运行的, 但是<strong>在唯一的结点出现硬件故障时有丢失数据的风险</strong>;<br> <img src="/img/est/blogs-unassigned-yellow.png"></p>
</li>
</ol>
<h2 id="故障转移"><a href="#故障转移" class="headerlink" title="故障转移"></a>故障转移</h2><ol>
<li><p><strong>添加故障转移</strong>: 当集群中只有一个节点在运行时, 意味着会有一个单点故障问题 —— 没有冗余; 幸运的是, 在ES中, 我们只需再启动一个节点即可防止数据丢失;</p>
<ul>
<li>启动第二个节点非常简单, 你可以在同一个目录内, 完全依照启动第一个节点的方式来启动一个新节点(多个节点可以共享同一个目); 只要它和第一个节点有同样的 cluster.name 配置, 它就会自动发现集群并加入到其中;</li>
<li>但是注意: 在不同一机器上启动节点的时候, 为了加入到同一集群, 你需要配置一个可连接到的<strong>单播主机列表</strong></li>
</ul>
</li>
<li><p><strong>单播</strong>, 组播   </p>
<ul>
<li><p>单播: Elasticsearch 默认被配置为使用单播发现, 以防止节点无意中加入集群, 只有在同一台机器上运行的节点才会自动组成集群;<br>除了同一台机器上的集群会自动发现同名节点, 使用单播, 你还可以为 Elasticsearch 提供一些它应该去尝试连接的节点列表, 当一个节点可以联系到单播列表中的成员(节点)时, 它就会得到整个集群所有节点的状态, 然后它会联系 master 节点, 并加入集群;<br><strong>这意味着你的单播列表不需要包含你的集群中的所有节点, 它只是需要足够的节点, 当一个新节点联系上其中一个并且说上话就可以了</strong>;<br>如果你使用 master 候选节点作为单播列表, 你只要列出三个就可以了, 这个配置在 elasticsearch.yml 文件中: <code>discovery.zen.ping.unicast.hosts: [&quot;host1&quot;, &quot;host2:port&quot;]</code></p>
</li>
<li><p>组播: 组播貌似仍然是作为插件提供, 并且它应该永远不要在生产环境使用, 否则可能会出现一个节点意外的加入到了你的生产环境集群中;<br>虽然组播 本身 并没有错, 但一不小心就会导致一些愚蠢的问题, 并且导致集群变的脆弱;</p>
</li>
<li><p>最好使用单播代替组播</p>
</li>
</ul>
</li>
<li><p>继续上面的第6点, 由于目前是在同一台机器上启动第二个节点, 所以不同配置单播列表, 直接启动一个节点即可; </p>
<ul>
<li>当启动第二个节点后, 由于其使用的是和第一个节点一样的配置, 集群名也就相同, 所以会自动加入到集群;</li>
<li>加入集群后, blogs 索引的 3个 副本分片 将会分配到这个节点上, 这意味着当集群内任何一个节点出现问题时, 我们的数据都完好无损;</li>
<li>所有新索引的文档都将会保存在主分片上, 然后被并行的复制到对应的副本分片上, 这就保证了我们既可以从主分片又可以从副本分片上获得文档;</li>
<li>并且 cluster-health 现在展示的状态为 green, 这表示所有6个分片(包括3个主分片和3个副本分片)都在正常运行;<br><img src="/img/est/blogs-green.png"></li>
</ul>
</li>
</ol>
<h2 id="水平扩容"><a href="#水平扩容" class="headerlink" title="水平扩容"></a>水平扩容</h2><ol>
<li><p>如何为我们的正在增长中的应用程序按需扩容呢? 再次尝试启动第三个新的节点, 会发现集群状态如下:<br> <img src="/img/est/blogs-green-03.png"></p>
</li>
<li><p>可以看到 Node 1 和 Node 2 上各有一个分片被迁移到了新的 Node 3 节点</p>
<ul>
<li>现在每个节点上都拥有2个分片, 而不是之前的3个, 这表示每个节点的硬件资源(CPU, RAM, I/O)将被更少的分片所共享, 每个分片的性能将会得到提升</li>
<li>分片是一个功能完整的搜索引擎, 它拥有使用一个节点上的所有资源的能力<br>也就是说, 目前我们这个拥有6个分片(3个主分片和3个副本分片)的索引, 可以最大扩容到6个节点, 让每个节点上只有该索引的一个分片(也可能会有其他索引的分片哦);</li>
</ul>
</li>
<li><p>分片数量一定, 增加节点, 则每个分片性能将会提升, 因为被赋予的更多的硬件资源; 但是当一个索引的分片数量和集群的节点数量达到一致时, 其分片性能达到最高, 继续增加更多的副本分片是不能提高性能的, 因为每个分片从节点上获得的资源会变少, 你需要增加更多的硬件资源来提升吞吐量;</p>
</li>
</ol>
<h2 id="更多的扩容提升搜索性能"><a href="#更多的扩容提升搜索性能" class="headerlink" title="更多的扩容提升搜索性能"></a>更多的扩容提升搜索性能</h2><ol>
<li><p>想要继续扩容超过6个节点, 需要先知道:</p>
<ul>
<li>由于索引的主分片数目在索引创建时就已经确定了, 这个数目定义了这个索引能够 存储 的最大数据量<br>也就是索引能存储的最大数据量在创建索引的时候就通过设置主分片数确定了(不过实际大小还取决于你的数据、硬件和使用场景)</li>
<li>由于 <strong>搜索操作 和 返回数据操作 可以同时被主分片 或 副本分片所处理</strong>, 所以当你拥有越多的副本分片时, 也将拥有越高的吞吐量</li>
</ul>
</li>
<li><p>在运行中的集群上是可以动态调整副本分片数目的, 比如, 可以把副本数从默认的 1 增加到 2 :</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT /blogs/_settings</span><br><span class="line">&#123;</span><br><span class="line">  &quot;number_of_replicas&quot; : 2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>blogs 索引现在拥有9个分片: 3个主分片和6个副本分片; 这就意味着可以将集群扩容到9个节点(每个节点上只放该索引的一个分片), 相比原来3个节点时(每个节点两个分片), 虽然存储量不变, 但是集群搜索性能可以提升 3 倍;</p>
</li>
<li><p>当一个索引的分片数量和集群的节点数量达到一致时, 其分片性能将达到最高, 无法再提升分片的性能! 此时可以 <strong>通过增加更多的副本分片, 同时增加节点来提升集群的搜索性能</strong>!</p>
</li>
<li><p>集群的整体性能还是需要通过增加节点来提高!</p>
</li>
</ol>
<h2 id="故障测试"><a href="#故障测试" class="headerlink" title="故障测试"></a>故障测试</h2><ol>
<li><p>目前的集群状态如下:<br> <img src="/img/est/blogs-green-03.png"></p>
</li>
<li><p>如果关闭<strong>主节点</strong></p>
<ul>
<li>由于而集群必须拥有一个主节点来保证正常工作, 所以发生的第一件事情就是选举一个新的主节点;</li>
<li><p>在我们关闭主节点的同时也失去了主分片 1 和 2, 并且在缺失主分片的时候索引也不能正常工作, 如果此时来检查集群的状况, 我们看到的状态将会为 red: 不是所有主分片都在正常工作<br><img src="/img/est/9200-down.png"></p>
</li>
<li><p>幸运的是, 在其它节点上存在着主节点上这两个主分片的完整副本, 所以新的主节点会立即将这两个主分片在 另外两个节点上 对应的副本分片提升为主分片, 此时集群的状态将会为 yellow: 这个提升主分片的过程是瞬间发生的, 如同按下一个开关一般<br>此时, 虽然我们又拥有所有的三个主分片, 但是由于之前设置了每个主分片需要对应2份副本分片, 而此时只有两个几点, 只存在一份副本分片, 所以集群不能为 green 的状态;<br>注意连接的端口:<br><img src="/img/est/9201-green.png"></p>
<p><img src="/img/est/9202-green.png"></p>
</li>
<li><p>如果重新启动之前关闭的节点, 集群可以将缺失的副本分片再次进行分配, 如果它依然拥有着之前的分片, 它将尝试去重用它们, 同时仅从主分片复制发生了修改的数据文件;<br><img src="/img/est/node-ok.png"></p>
</li>
</ul>
</li>
</ol>
<h2 id="配置相关"><a href="#配置相关" class="headerlink" title="配置相关"></a>配置相关</h2><ol>
<li><p>注意: discovery.zen.minimum_master_nodes ??</p>
</li>
<li></li>
</ol>

        </div>

        <blockquote class="post-copyright">
    <div class="content">
        

        
    </div>
    <footer>
        <a href="http://blog.renyimin.com">
            <img src="/img/avatar.jpeg" alt="Lant">
            Lant
        </a>
    </footer>
</blockquote>

        
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>



        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Elasticsearch/">Elasticsearch</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://blog.renyimin.com/2018/06/10/elasticsearch/2018-06-10-03/&title=《03. 集群相关 (节点, 分片及角色, 扩容, 故障测试)》 — Lant's&pic=http://blog.renyimin.com/img/avatar.jpeg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://blog.renyimin.com/2018/06/10/elasticsearch/2018-06-10-03/&title=《03. 集群相关 (节点, 分片及角色, 扩容, 故障测试)》 — Lant's&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://blog.renyimin.com/2018/06/10/elasticsearch/2018-06-10-03/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《03. 集群相关 (节点, 分片及角色, 扩容, 故障测试)》 — Lant's&url=http://blog.renyimin.com/2018/06/10/elasticsearch/2018-06-10-03/&via=http://blog.renyimin.com" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://blog.renyimin.com/2018/06/10/elasticsearch/2018-06-10-03/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
      <div class="waves-block waves-effect prev">
        <a href="/2018/06/08/elasticsearch/2018-06-08-02/" id="post-prev" class="post-nav-link">
          <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i>Prev </div>
          <h4 class="title">02. 适应一下ES</h4>
        </a>
      </div>
    
  
    <div class="waves-block waves-effect next">
      <a href="/2018/06/10/elasticsearch/2018-06-10-04/" id="post-next" class="post-nav-link">
        <div class="tips">Next<i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">04. 文档的概念 及 ES乐观并发控制</h4>
      </a>
    </div>
  
</nav>



    











<section class="comments" id="comments">
    <div id="gitment_thread"></div>
    <link rel="stylesheet" href="//unpkg.com/gitment/style/default.css">
    <script src="//unpkg.com/gitment/dist/gitment.browser.js"></script>
    <script>
        var gitment = new Gitment({
            owner: 'rymuscle',
            repo: 'rymuscle.github.io',
            oauth: {
                client_id: '49b906f6d47dbab8d929',
                client_secret: '17fd73f24f616a09d4c09bca9480e0deba75a9a2',
            },
        })
        gitment.render('comments')
    </script>
</section>




</article>

<div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        赞赏支持
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/img/wechat.png" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <input id="rewardToggle" type="checkbox" class="reward-toggle-check"
                data-wechat="/img/wechat.png" data-alipay="/img/alipay.png">
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-label"></span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>



</div>

        <footer class="footer">
    <div class="bottom">
        <p><span>Lant &copy; 2016 - 2018</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://blog.renyimin.com/2018/06/10/elasticsearch/2018-06-10-03/&title=《03. 集群相关 (节点, 分片及角色, 扩容, 故障测试)》 — Lant's&pic=http://blog.renyimin.com/img/avatar.jpeg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://blog.renyimin.com/2018/06/10/elasticsearch/2018-06-10-03/&title=《03. 集群相关 (节点, 分片及角色, 扩容, 故障测试)》 — Lant's&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://blog.renyimin.com/2018/06/10/elasticsearch/2018-06-10-03/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《03. 集群相关 (节点, 分片及角色, 扩容, 故障测试)》 — Lant's&url=http://blog.renyimin.com/2018/06/10/elasticsearch/2018-06-10-03/&via=http://blog.renyimin.com" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://blog.renyimin.com/2018/06/10/elasticsearch/2018-06-10-03/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACqElEQVR42u3cQU4DMQwF0N7/0rCFRcv/cQwVerMaUZjmBclxbauPR3x9fLkmrybX6799bFx4eHh4g6U/e9yc9/o+edqz9fywBXh4eHhrvHZZScguFjHYph8seHh4eG/DS4J4Htxf58N4eHh4/4N3a6HJcYKHh4f3nrykGNGG+PYIyUshK7UWPDw8vK4OEHWR3ud+pb+Hh4eHN+6qnwXcswCdp9HFavHw8PAWeHnAzRedlHTbAnH77nh4eHjbvHZxkzZYUX4dlCHw8PDw9nhti6sN9MmWtf+Nov2Gh4eH90e8yUBA/oRbCffTzwp4eHh4l3hnQ1RJep0nyu0m1s0wPDw8vDVeW0idJ9l5qj0pTODh4eHd5Z0F9Dy4Jwtqn1YcFXh4eHi/yGuDePubLf7w0MLDw8Nb5rXJ7qTx39YQ2uPqcA4CDw8Pr0stL3whVFu63fh5lF7j4eHhXeLdSn/zImw7pDUZUMDDw8O7xWtLt0nbqS3RtltQpPt4eHh4a7zXhYY8mb5V9p2PeX0r4+Lh4eFd5SWl1TYoJ4tuN7Ed7cLDw8Pb47VjT5Nqx3zcqt4yPDw8vAXeWcM+T4LnCz1Lu4sBAjw8PLySl49DHbbq4zLupA0WfVbAw8PDu8RLgm+S/iaDVm2b7dbIAh4eHt4eb/JmbXo92bI21cbDw8Pb4xXDTEctq0kJ4+yowMPDw9vmtS2utti62NbKu3x4eHh4Y95HeU3KBGdHUXvMRNO4eHh4eANeG3AnmPZ+0nKrLzw8PLySlxwGbXBPQnk7upo8DQ8PD+83eUmJdg4YVU2ODjA8PDy8d+C1AweTEYF2PVGVGg8PD+9PeXlafDagMB/PwsPDw9vjtYWA9tVkBCFvj+UbhIeHh7fBO0tnzxjtgTEvauDh4eFd5X0CdhQr8D5gPuEAAAAASUVORK5CYII=" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: true };


</script>

<script src="/js/main.min.js?v=1.6.13"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="/js/search.min.js?v=1.6.13" async></script>










</body>
</html>
