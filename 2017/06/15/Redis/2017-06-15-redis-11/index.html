<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    
    <title>11. 了解redis持久化 | Lant&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="Redis">
    <meta name="description" content="Redis的两种持久化模式介绍 RDB(Redis DB)简介 RDB持久化功能可以将redis服务器包含的所有数据库数据以二进制文件(.rdb文件)的形式保存到硬盘;  RDB 默认是开启的, 关闭方式有:  注释掉配置文件中save策略行;  在所有save策略下添加save &amp;quot;&amp;quot;;   创建RDB文件, 常见的三种方式  给redis服务器发送SAVE命令; 给redis">
<meta name="keywords" content="Redis">
<meta property="og:type" content="article">
<meta property="og:title" content="11. 了解redis持久化">
<meta property="og:url" content="http://blog.renyimin.com/2017/06/15/Redis/2017-06-15-redis-11/index.html">
<meta property="og:site_name" content="Lant&#39;s Blog">
<meta property="og:description" content="Redis的两种持久化模式介绍 RDB(Redis DB)简介 RDB持久化功能可以将redis服务器包含的所有数据库数据以二进制文件(.rdb文件)的形式保存到硬盘;  RDB 默认是开启的, 关闭方式有:  注释掉配置文件中save策略行;  在所有save策略下添加save &amp;quot;&amp;quot;;   创建RDB文件, 常见的三种方式  给redis服务器发送SAVE命令; 给redis">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2018-03-08T09:48:55.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="11. 了解redis持久化">
<meta name="twitter:description" content="Redis的两种持久化模式介绍 RDB(Redis DB)简介 RDB持久化功能可以将redis服务器包含的所有数据库数据以二进制文件(.rdb文件)的形式保存到硬盘;  RDB 默认是开启的, 关闭方式有:  注释掉配置文件中save策略行;  在所有save策略下添加save &amp;quot;&amp;quot;;   创建RDB文件, 常见的三种方式  给redis服务器发送SAVE命令; 给redis">
    
        <link rel="alternate" type="application/atom+xml" title="Lant&#39;s Blog" href="/atom.xml">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="/css/style.css?v=1.6.13">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpeg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">Lant</h5>
          <a href="mailto:564613464@qq.com" title="564613464@qq.com" class="mail">564613464@qq.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                归档
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                标签
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                分类
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/rymuscle" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">11. 了解redis持久化</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">11. 了解redis持久化</h1>
        <h5 class="subtitle">
            
                <time datetime="2017-06-15T05:40:54.000Z" itemprop="datePublished" class="page-time">
  2017-06-15
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Redis/">Redis</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#RDB-Redis-DB"><span class="post-toc-number">1.</span> <span class="post-toc-text">RDB(Redis DB)</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#简介"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">简介</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#三种方式的区别"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">三种方式的区别</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#RDB持久化问题"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">RDB持久化问题</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#rdb持久化的优点"><span class="post-toc-number">1.4.</span> <span class="post-toc-text">rdb持久化的优点</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#rdb持久化的缺点"><span class="post-toc-number">1.5.</span> <span class="post-toc-text">rdb持久化的缺点</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#AOF-Append-Only-File"><span class="post-toc-number">2.</span> <span class="post-toc-text">AOF (Append Only File)</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#简介-1"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">简介</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#aof需要注意的问题"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">aof需要注意的问题</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#AOF模式三种追加策略"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">AOF模式三种追加策略</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#AOF文件中的冗余命令-aof文件重写"><span class="post-toc-number">2.4.</span> <span class="post-toc-text">AOF文件中的冗余命令(aof文件重写)</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#如果AOF文件出错了"><span class="post-toc-number">2.5.</span> <span class="post-toc-text">如果AOF文件出错了</span></a></li></ol></li></ol>
        </nav>
    </aside>
    
<article id="post-Redis/2017-06-15-redis-11"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">11. 了解redis持久化</h1>
        <div class="post-meta">
            <time class="post-time" title="2017-06-15 13:40:54" datetime="2017-06-15T05:40:54.000Z"  itemprop="datePublished">2017-06-15</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Redis/">Redis</a></li></ul>



            

        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <p>Redis的两种持久化模式介绍</p>
<h2 id="RDB-Redis-DB"><a href="#RDB-Redis-DB" class="headerlink" title="RDB(Redis DB)"></a>RDB(Redis DB)</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><ol>
<li><p>RDB持久化功能可以将redis服务器包含的所有数据库数据以二进制文件(<code>.rdb文件</code>)的形式保存到硬盘;</p>
</li>
<li><p>RDB <strong>默认是开启的</strong>, 关闭方式有:</p>
<ul>
<li>注释掉配置文件中save策略行; </li>
<li>在所有save策略下添加<code>save &quot;&quot;</code>;</li>
</ul>
</li>
<li><p>创建RDB文件, 常见的三种方式</p>
<ul>
<li>给redis服务器发送<code>SAVE</code>命令;</li>
<li>给redis服务器发送<code>BGSAVE</code>命令;</li>
<li>在redis配置文件中配置rdb持久化的<code>save策略</code>, 如果配置选项被满足, 则服务器会自动执行<code>BGSAVE</code>;</li>
<li>这三种创建RDB的方式, 前两种需要手动去执行;而第三种是服务器自动执行的;</li>
</ul>
</li>
<li><p>rdb文件每次都是<strong>覆盖创建</strong>, 所以为了安全起见, 需要不时地去备份生成的rdb文件;</p>
</li>
</ol>
<h3 id="三种方式的区别"><a href="#三种方式的区别" class="headerlink" title="三种方式的区别"></a>三种方式的区别</h3><ol>
<li><p>通过使用客户端向redis服务器发送<code>SAVE</code>命令, 可以命令服务器去创建一个新的RDB文件;</p>
<ul>
<li><strong>注意:</strong> 在redis服务器执行SAVE命令的过程中(也即创建RDB文件的过程中), redis服务器将被阻塞, 服务器端无法再去处理客户端发送的命令请求, 只有在SAVE命令执行完毕之后(也即RDB文件创建完毕之后), 服务器才会重新开始处理客户端发送的命令请求;</li>
<li><strong>注意:</strong> 如果rdb文件已经存在, 服务器会自动使用新的rdb文件去代替旧的rdb文件;<br>所以: 之前的rdb文件你可以用定时脚本定时地拷走, 可以防止外一执行了<code>flush db</code>并且服务器进行了<code>save</code>, 此时旧的rdb会被新的rdb文件覆盖掉, 那就完蛋了!!!  </li>
</ul>
</li>
<li><p>通过使用客户端向redis服务器发送<code>BGSAVE</code>命令,也可以命令服务器去创建一个新的RDB文件;</p>
<ul>
<li><p><strong>注意:</strong> BGSAVE命令不会造成服务器阻塞, 也就是说redis服务器在执行BGSAVE命令的过程中, redis服务器仍然可以正常的处理其他客户端发送的命令请求;<br>BGSAVE命令不会造成服务器阻塞的原因在于:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">当redis服务器接收到BGSAVE命令后,它不会亲自去创建rdb持久化文件,而是通过fork一个子进程,然后由子进程去负责这个rdb文件的生成, 自己则继续处理客户端的命令请求;</div><div class="line">当子进程创建好rdb文件并退出后, 它会向父进程(也就是负责处理命令请求的redis服务器)发送一个信号,告知redis服务器rdb文件已经创建完毕;</div></pre></td></tr></table></figure>
</li>
<li><p><strong>注意:</strong> 由于创建子进程会消耗额外的内存, 所以<strong>save创建RDB文件的速度其实会比bgsave快</strong>, 因为它可以集中资源来创建rdb文件;</p>
</li>
<li><p><code>save</code> 和 <code>bgsave</code> 没有孰好孰坏, 你要考虑哪个更适合你<br>如果你的数据库正在上线当中, 自然使用 <code>bgsave</code> (让服务器以非阻塞方式进行最好);<br>相反,如果你需要在凌晨3点钟维护你的redis, 比如维护需要停机一小时, 这时系统被阻塞了也是没关系的, 这时候你使用save命令就会好一点; </p>
</li>
</ul>
</li>
<li><p>自动创建rdb文件</p>
<ul>
<li>通过在redis配置文件中配置redis服务器创建rdb文件的条件, 就可以让服务器在客户端操作满足save策略所指定的条件时, 自动去创建rdb文件;</li>
<li>比如, redis默认情况下就是开启rdb持久化的, 并且制定了默认的save条件:<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">save 900 1    #900秒（15分钟）内至少1个key值改变（则进行数据库保存--持久化）    </div><div class="line">save 300 10   #300秒（5分钟）内至少10个key值改变（则进行数据库保存--持久化）    </div><div class="line">save 60 10000 #60秒（1分钟）内至少10000个key值改变（则进行数据库保存--持久化）</div><div class="line">这些默认的save选项的意思是:</div><div class="line">只要三个条件中的任意一个条件被满足时,服务器就会自动执行 BGSAVE 命令来创建新的rdb文件;   </div><div class="line">每次创建完rdb文件之后,服务器为实现自动持久化会将&apos;为实现持久化而设置的时间计数器和次数计数器清零并重新开始计数&apos;, 所以多个保存条件的效果是不会叠加的;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>
<h3 id="RDB持久化问题"><a href="#RDB持久化问题" class="headerlink" title="RDB持久化问题"></a>RDB持久化问题</h3><ol>
<li><p><strong>redis关机持久化</strong>: 当你正常关闭redis的时候, redis服务器不会参考配置中的save策略; 而是会直接先调用save命令, 将redis所有数据持久化到磁盘之后才会真正进行退出;</p>
</li>
<li><p><strong>redis - crash不持久化问题</strong>: 而当redis服务器意外断电宕机的时候, 你会发现从上一次快照之后的数据将全部丢失;</p>
</li>
</ol>
<h3 id="rdb持久化的优点"><a href="#rdb持久化的优点" class="headerlink" title="rdb持久化的优点"></a>rdb持久化的优点</h3><ol>
<li><p>重建快: 在redis里, 默认使用RDB模式, 因为RDB模式重建数据库比较快, 这里的<code>重建数据库</code>是指将数据从硬盘移到内存,并建立起数据库的过程;</p>
<ul>
<li>因为对于RDB模式来说, 重建就是把 <code>dump.rdb</code> 文件加载到内存, 并解压字符串,就建立起了数据库;</li>
<li>而对于AOF模式来说, 则是在启动Redis服务器的时候, 运行<code>appendonly.aof</code>日志文件, 在内存中重新建立数据库; 所以从这里的描述就可以看出,AOF的重建过程是要比RDB慢的;</li>
</ul>
</li>
<li><p>使用RDB模式的话， 系统会将内存中数据库的快照每隔一段时间间隔更新到硬盘中(dump.rdb 文件里), 这个更新的频率是可以指定的。</p>
<ul>
<li><p>在redis.conf中有三个配置用来指定内存数据更新到硬盘的频率：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">//格式是：save &lt;seconds&gt; &lt;changes&gt;</div><div class="line">save 900 1           //如果仅有1-9次更改操作，那么要900s才写入硬盘一次</div><div class="line">save 300 10          //如果仅有10-9999次更改操作，那么要300s才写入硬盘一次</div><div class="line">save 60 10000        //如果超过10000次更改操作，那么60s才会写入硬盘一次</div></pre></td></tr></table></figure>
</li>
<li><p>900s(也就是15分钟), 300s(就是5分钟): 这个时间挺长的, 这正是RDB模式的缺点所在<br>如果服务器宕机的话, 可能会造成最后几分钟, 保存在内存中还来不及刷入硬盘的数据丢失, 如果数据很重要那就惨了; 但是如果数据不是那么重要, 丢失几分钟数据也没什么关系, 那么RDB模式是最好的选择。</p>
</li>
</ul>
</li>
</ol>
<h3 id="rdb持久化的缺点"><a href="#rdb持久化的缺点" class="headerlink" title="rdb持久化的缺点"></a>rdb持久化的缺点</h3><ol>
<li><p>由于创建RDB文件需要将服务器所有的数据库的数据都保存起来, <strong>这是一个非常消耗资源和时间的操作</strong>, 所以服务器需要隔一段事件再来创建一个新的rdb文件, 也就是说<strong>rdb文件的创建操作不能执行的过于频繁, 否则将会严重影响服务器的性能</strong>;</p>
</li>
<li><p>由于只能隔一段时间再去创建一下rdb文件, 所以如果在间隔的这段时间中服务器宕机, 那这段间隔中的数据就丢失了, 比如redis服务在创建rdb文件时, 如果使用了默认的save选项, 可能就会丢失60秒的数据, 这就有点严重了!!!</p>
</li>
<li><p>所以为了解决这个问题, <code>rdb可以结合aof来一起进行持久化</code><br> aof就解决了服务器不能频繁执行rdb持久化的问题!</p>
</li>
</ol>
<h2 id="AOF-Append-Only-File"><a href="#AOF-Append-Only-File" class="headerlink" title="AOF (Append Only File)"></a>AOF (Append Only File)</h2><h3 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h3><ol>
<li><p>为了解决rdb持久化在服务器意外宕机的情况下造成的数据严重丢失的问题, redis还提供了另外一种持久化方案, 那就是 <code>aof持久化</code>!</p>
</li>
<li><p>AOF模式是将<code>操作日志</code>记在<code>appendonly.aof</code>文件里, 每次启动服务器就会运行<code>appendonly.aof</code>里的<code>命令</code>重新建立数据库;</p>
<ul>
<li>因为要重新运行命令, 所以appendonly.aof是比较慢的, 默认AOF模式也是关闭的;</li>
<li>你可以在redis配置文件(redis.conf)中, 配置 <code>appendonly yes</code> 打开AOF模式;</li>
</ul>
</li>
</ol>
<h3 id="aof需要注意的问题"><a href="#aof需要注意的问题" class="headerlink" title="aof需要注意的问题"></a>aof需要注意的问题</h3><ol>
<li><p>在aof持久化的模式下, 虽然redis服务器在执行修改数据的命令后, 会把执行的命令写入到aof文件中, <strong><em>但这并不意味着aof文件持久化不会丢失任何数据</em></strong>;</p>
<ul>
<li>在常见的操作系统中, 执行系统调用write函数, 将一些内容写到某个文件中时, 为了提高效率, 系统通常不会直接将内容写入到磁盘里面, 而是先将内容放入一个内存缓冲区(buffer)里面, 等到缓冲区被填满, 或者用户执行<code>fsync</code>调用和<code>fdatasync</code>调用时, 系统才会将存储在缓冲区里面的内容真正写入到硬盘里;</li>
<li><p>所以对AOF持久化来说, 当一条命令真正的被写入到硬盘里面时, 这条命令才不会因停机而意外丢失;</p>
</li>
<li><p>因此,aof持久化在遭遇停机时丢失命令的数量, 取决于命令被写入到硬盘的时间;<br>越早将命令写入到硬盘,发生意外停机时丢失的数据就越少;<br>而越迟将命令写入硬盘,发生意外停机时丢失的数据就越多;</p>
</li>
</ul>
</li>
<li><p>所以aof持久化模式还有三种执行策略供你选择;</p>
</li>
</ol>
<h3 id="AOF模式三种追加策略"><a href="#AOF模式三种追加策略" class="headerlink" title="AOF模式三种追加策略"></a>AOF模式三种<code>追加</code>策略</h3><p>这三种追加策略主要就是用来指定什么时机可以将操作日志<strong><em>真正追加</em></strong>到appendonly.aof文件里;</p>
<ol>
<li><p><code>always</code> : 服务器每写入一个命令, 就调用一次fdatasync, 将缓冲区里面的命令写入到磁盘文件中, 在这种模式下, 服务器即使遭遇意外停机, 也不会丢失任何自己已经成功执行的命令数据;<br> 比较安全, 但比较慢; (类似mysql了)</p>
</li>
<li><p><code>everysec</code>: 服务器每一秒重新调用一次fdatasync, 将缓冲区里面的操作日志写入到磁盘文件中, 这是系统默认的方式, 是一种<strong>权衡折衷</strong>;<br> 通常这种方式会比较好, 在这种模式下, 服务器即使遭遇意外停机时, 最多只丢失一秒钟的内执行的命令;</p>
</li>
<li><p><code>no</code>: 服务器不主动调用fdatasync, 由操作系统去决定什么时候将缓冲区里面的命令写入到硬盘里面;<br> 在这种模式下,服务器遭遇意外停机时, <strong>丢失的命令数量是不确定的</strong>;</p>
</li>
<li><p>可以在redis.conf中配置这三种策略</p>
<ul>
<li>可以看到默认使用的是everysec这种折中策略;<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># appendfsync always</div><div class="line">appendfsync everysec</div><div class="line"># appendfsync no</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>
<h3 id="AOF文件中的冗余命令-aof文件重写"><a href="#AOF文件中的冗余命令-aof文件重写" class="headerlink" title="AOF文件中的冗余命令(aof文件重写)"></a>AOF文件中的冗余命令(aof文件重写)</h3><ol>
<li><p>随着服务器的不断运行,为了记录数据库发生的变化, 服务器会将越来越多的命令写入到aof文件中, 使得aof文件的体积不断增大;</p>
</li>
<li><p>为了让aof文件的大小控制在合理的范围, 避免它疯狂增长, redis提供了AOF重写功能, 通过这个功能, 服务器可以产生一个新的aof文件:</p>
<ul>
<li>新的aof文件记录的内容和原有的aof文件记录的内容在redis服务器重建数据后, 数据完全一样;</li>
<li>新的aof文件会使用尽可能少的命令来记录数据库数据, 因此新的aof文件的体积通常会比原有aof文件的体积要小得多;</li>
<li>aof重写期间, <strong>服务器不会被阻塞</strong>, 可以正常处理客户端发送的命令请求;</li>
</ul>
</li>
<li><p>有两种方法可以触发aof文件重写</p>
<ul>
<li>客户端向服务器发送 <code>BGREWRITEAOF</code> 命令;</li>
<li><p>通过设置配置文件选项来让服务器自动执行<code>BGWRITEAOF</code>命令;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">auto-aof-rewrite-min-size &lt;size&gt;</div><div class="line">触发aof重写所需的最小体积:</div><div class="line">只要aof文件的体积大于等于size时,服务器才会考虑是否需要进行aof重写,</div><div class="line">这个选项用于避免对体积过小的aof文件进行重写</div><div class="line"></div><div class="line">auto-aof-rewrite-percentage 100</div><div class="line">指定触发重写所需的aof文件体积百分比, 当aof文件的体积大于auto-aof-rewrite-min-size指定的体积,并且超过上一次重写之后的aof文件体积的percent%时, 就会触发aof重写,(如果服务器启动刚刚不就,还没有进行过aof重写,那么使用服务器启动时载入的aof文件体积来作为基准值)将这个值设置为0表示关闭自动aof重写;</div></pre></td></tr></table></figure>
</li>
<li><p>例子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">//只有当aof文件的增量大于100%的时候才进行重写</div><div class="line">auto-aof-rewrite-percentage 100</div><div class="line">//当aof文件大于64mb之后才考虑进行aof重写,还需要看上一条的百分比增量够不够</div><div class="line">auto-aof-rewrite-min-size 64mb</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>
<h3 id="如果AOF文件出错了"><a href="#如果AOF文件出错了" class="headerlink" title="如果AOF文件出错了"></a>如果AOF文件出错了</h3><ol>
<li>服务器可能在程序正在对AOF文件进行写入时停机, 如果停机造成了AOF文件出错(corrupt), 那么 Redis 在重启时会拒绝载入这个 AOF 文件, 从而确保数据的一致性不会被破坏;</li>
<li>当发生这种情况时,可以用以下方法来修复出错的 AOF 文件：<ul>
<li>首先先为现有的 AOF 文件创建一个备份;</li>
<li>然后使用 Redis 附带的 <code>redis-check-aof</code> 程序, 对原来的 AOF 文件进行修复: <code>$ redis-check-aof --fix</code></li>
<li>(可选)使用 <code>diff -u</code> 对比修复后的 AOF 文件和原始 AOF文件的备份, 查看两个文件之间的不同之处。</li>
<li>重启 Redis 服务器，等待服务器载入修复后的 AOF 文件，并进行数据恢复。</li>
</ul>
</li>
</ol>

        </div>

        <blockquote class="post-copyright">
    <div class="content">
        

        
    </div>
    <footer>
        <a href="http://blog.renyimin.com">
            <img src="/img/avatar.jpeg" alt="Lant">
            Lant
        </a>
    </footer>
</blockquote>

        
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>



        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Redis/">Redis</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://blog.renyimin.com/2017/06/15/Redis/2017-06-15-redis-11/&title=《11. 了解redis持久化》 — Lant's Blog&pic=http://blog.renyimin.com/img/avatar.jpeg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://blog.renyimin.com/2017/06/15/Redis/2017-06-15-redis-11/&title=《11. 了解redis持久化》 — Lant's Blog&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://blog.renyimin.com/2017/06/15/Redis/2017-06-15-redis-11/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《11. 了解redis持久化》 — Lant's Blog&url=http://blog.renyimin.com/2017/06/15/Redis/2017-06-15-redis-11/&via=http://blog.renyimin.com" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://blog.renyimin.com/2017/06/15/Redis/2017-06-15-redis-11/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
      <div class="waves-block waves-effect prev">
        <a href="/2017/06/12/Redis/2017-06-12-redis-08/" id="post-prev" class="post-nav-link">
          <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i>Prev </div>
          <h4 class="title">08. redis锁 -- 不太安全?</h4>
        </a>
      </div>
    
  
    <div class="waves-block waves-effect next">
      <a href="/2017/06/18/Redis/2017-06-18-redis-13/" id="post-next" class="post-nav-link">
        <div class="tips">Next<i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">13. redis 主从, 哨兵</h4>
      </a>
    </div>
  
</nav>



    











<section class="comments" id="comments">
    <div id="gitment_thread"></div>
    <link rel="stylesheet" href="//unpkg.com/gitment/style/default.css">
    <script src="//unpkg.com/gitment/dist/gitment.browser.js"></script>
    <script>
        var gitment = new Gitment({
            owner: 'rymuscle',
            repo: 'rymuscle.github.io',
            oauth: {
                client_id: '49b906f6d47dbab8d929',
                client_secret: '17fd73f24f616a09d4c09bca9480e0deba75a9a2',
            },
        })
        gitment.render('comments')
    </script>
</section>




</article>

<div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        赞赏支持
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/img/wechat.png" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <input id="rewardToggle" type="checkbox" class="reward-toggle-check"
                data-wechat="/img/wechat.png" data-alipay="/img/alipay.png">
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-label"></span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>



</div>

        <footer class="footer">
    <div class="top">
        

        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>博客内容遵循 <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></span>
        </p>
    </div>
    <div class="bottom">
        <p><span>Lant &copy; 2016 - 2018</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://blog.renyimin.com/2017/06/15/Redis/2017-06-15-redis-11/&title=《11. 了解redis持久化》 — Lant's Blog&pic=http://blog.renyimin.com/img/avatar.jpeg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://blog.renyimin.com/2017/06/15/Redis/2017-06-15-redis-11/&title=《11. 了解redis持久化》 — Lant's Blog&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://blog.renyimin.com/2017/06/15/Redis/2017-06-15-redis-11/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《11. 了解redis持久化》 — Lant's Blog&url=http://blog.renyimin.com/2017/06/15/Redis/2017-06-15-redis-11/&via=http://blog.renyimin.com" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://blog.renyimin.com/2017/06/15/Redis/2017-06-15-redis-11/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACK0lEQVR42u3awY7DIAxF0f7/T6fbkUYk99mkEnBZVWrScLJwbezPB69rsP5++//60efR9aNvpy0ZMmQsy7hu1/1G+b3p9XxvMmTIOIcximA8gKZB9j5y8r3JkCFDBt/6KBzfP4W/DhkyZMggDB5q00TzpwFXhgwZyzJ4IZpupZZuvliLy5AhY0FGp7B8+/Mr/Q0ZMmQsxbjClVLTBkBxVzJkyNiaMfeRJCnkqSdpKsiQIeMEBj+s54f+o+tJoVsM8TJkyNia0T9uqw1SpGNnaIBDhgwZmzLIJu7DLi9i3wi4KH+UIUPG4oxOA5I3MtOATniIKkOGjO0YaWBNxyn4NekTZciQcQ4jHbDolK+1Fib/Y5AhQ8ZOjLR5OSsp5M1OFKZlyJBxAKPThuRlcEoKkDJkyNiawY/1ObhffPJxMRkyZJzAqDURgzkOfFerVJYhQ8YBjH7nk7Qkya+loVyGDBknMNJSttbsnFXWTjt0kyFDxoKM9OBswgAE/v1p5bEMGTIWZ5CtdJK5dDi1+ApkyJBxAKNWcM5N/vgeHobsZciQsR2jkwiSBud7g7CoHytDhozFGVe40mM13k4gvId3L0OGjE0ZabmYDoqlbcvaKIYMGTJOYPAg2z8US0c3gvaqDBkyDmDUHp+OjqV3BbW4DBkyZDQCbm3AgqeSMmTIkMGP+Dv4tMEpQ4aMMxn9IrY2rsH38ECSIUPG1oxaMscP9NOjtH6KKUOGjI0YX21l4AZh+WKKAAAAAElFTkSuQmCC" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: true };


</script>

<script src="/js/main.min.js?v=1.6.13"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="/js/search.min.js?v=1.6.13" async></script>










</body>
</html>
